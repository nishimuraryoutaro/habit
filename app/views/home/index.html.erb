
<div class="container my-4">
  <% if @goal.blank? %>
      <div class="alert alert-info">プロフィールで目標を作成してください。</div>
      <%= link_to "プロフィールへ", profile_path(current_user), class:"btn btn-primary" %>
  <% end %>
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white">最終目標</div>
      <div class="card-body">
        <h5 class="mb-2"><%= @goal.title %></h5>
        <div class="text-muted xsmall mb-2">
          期間: <%= @goal.start_date || "—" %> 〜 <%= @goal.target_date || "—" %>
        </div>
        <p class="text-muted xsmall"><%= @goal.description %></p>
        <div class="progress"><div class="progress-bar bg-success" style="width:%">%</div></div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-8">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <h6 class="mb-0">今日のタスク（<%= @selected_date %>）</h6>
        <small class="text-muted"><%= @done_count %>/<%= @total_count %> 完了</small>
      </div>
      <div class="card-body p-0">
        <ul class="list-group list-group-flush">
          <% @todos_today.each do |t| %>
            <li class="list-group-item d-flex align-items-center" data-controller="check">
              <%= form_with model: t, url: daily_task_path(t), method: :patch, class:"d-flex align-items-center w-100", data:{ check_target:"form" } do |f| %>
                <div class="form-check me-2">
                  <%= f.check_box :done, class:"form-check-input", checked:t.done, data:{ action:"change->check#toggle", check_target:"checkbox" } %>
                </div>
                <span class="flex-grow-1 <%= 'task-done' if t.done %>" data-check-target="label"><%= t.title %></span>
              <% end %>
            </li>
          <% end %>
          <% if @todos_today.empty? %>
            <li class="list-group-item text-muted small">この日に設定されたタスクはまだありません。</li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
  <% if @goal.present? %>
    <%= link_to "この日のタスクを編集",
        new_daily_task_path(goal_id: @goal.id, date: @selected_date),
        class:"btn btn-sm btn-outline-primary" %>
  <% end %>
  <% if @goal.present? %>
    <%= link_to "edit", edit_goal_path(@goal) %>
  <% else %>
    <%= link_to "Goalを作成", new_goal_path %>
  <% end %>

  <div class="card shadow-sm mt-3">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <span>カレンダー（ゴール期間）</span>
      <% if @goal_one && @goal_three %>
        <div class="xsmall">
          <%= link_to "3ヶ月のゴールを表示", root_path(goal_id: @goal_three.id, date: @selected_date) %> /
          <%= link_to "1ヶ月のゴールを表示", root_path(goal_id: @goal_one.id,   date: @selected_date) %>
        </div>
      <% end %>
    </div>
    <div class="card-body">
      <% if @goal %>
        <div class="calendar-grid">
          <% ["月","火","水","木","金","土","日"].each do |w| %>
            <div class="calendar-cell calendar-head"><%= w %></div>
          <% end %>
          <% @period_days.each do |day| %>
            <% count = @days_with_counts.to_h[day] || 0 %>
            <%= link_to root_path(goal_id: @goal.id, date: day.iso8601),class:"calendar-cell #{'calendar-active' if day == @selected_date}" do %>
              <span><%= day.day %></span>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="text-muted">表示する目標がありません</div>
      <% end %>
    </div>
  </div>
</div>